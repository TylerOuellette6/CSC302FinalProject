<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Data Editor</title>
	<!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<!-- Styles -->
    <link rel="stylesheet" href="normalize.css"/>
    <link rel="stylesheet" href="style.css"/>
	

    <!-- jsGrid -->
    <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.min.css" />
	<link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid-theme.min.css" />
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.min.js"></script>

    <!-- Boostrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

    <script>
		
		var edgeData = localStorage.getItem('edgeData');
		var nodeData = localStorage.getItem('nodeData');
		var headers = localStorage.getItem('headers');

		var headerSetting = localStorage.getItem('headerSetting');
		var graphTypeSetting = localStorage.getItem('graphTypeSetting');
		var mergeTypeSetting = localStorage.getItem('mergeTypeSetting');

    	$(document).ready(function(){
    		localStorage.clear();
			$("#data_page").hide();

    		$(document).on('click', "#create-tables", createTables)
    		$(document).on('click', "#return-to-uploads", returnToUploads)

    		document.getElementById('upload-edge-file').addEventListener('change', handleEdgeFileUpload, false)
    		document.getElementById('upload-node-file').addEventListener('change', handleNodeFileUpload, false)

    		document.getElementById('header-yes').addEventListener('change', handleHeaderYes, false)
    		document.getElementById('header-no').addEventListener('change', handleHeaderNo, false)
    		document.getElementById('graph-undirected').addEventListener('change', handleGraphUndirected, false)
    		document.getElementById('graph-directed').addEventListener('change', handleGraphDirected, false)
    		document.getElementById('merge-sum').addEventListener('change', handleMergeSum, false)
    		document.getElementById('merge-dontmerge').addEventListener('change', handleMergeDontMerge, false)


    	});

    	var handleHeaderYes = function(event){
    		localStorage.setItem('headerSetting', 'yes');
    		var allDataArray = edgeData.split("\n");
    		var justHeaders = allDataArray[0].split(",");
    		localStorage.setItem('headers', justHeaders);

    		var sourceSelection = document.getElementById("source-selection");
    		var targetSelection = document.getElementById("target-selection");

    		var sourceh5 = document.createElement("h5");
    		sourceh5.innerHTML = "Source: ";
    		sourceSelection.appendChild(sourceh5);

    		var targeth5 = document.createElement("h5");
    		targeth5.innerHTML = "Target: ";
    		targetSelection.appendChild(targeth5);

    		radioButtonMaker = function($vertex, $headerText, $divElement){
    			var radioButton = document.createElement("input");
	    		radioButton.setAttribute("type", "radio");
	    		radioButton.setAttribute("id", $vertex + $headerText);
	    		radioButton.setAttribute("class", "radio");

	    		var radioButtonText = document.createElement("label");
    			radioButtonText.innerHTML = $headerText;

    			$divElement.appendChild(radioButton);
    			$divElement.appendChild(radioButtonText);
    		}

    		var i;
    		for(i=0; i<justHeaders.length; i++){
    			radioButtonMaker("source", justHeaders[i], sourceSelection);
    			radioButtonMaker("target", justHeaders[i], targetSelection);
    		}
    	}
    	var handleHeaderNo = function(event){localStorage.setItem('headerSetting', 'no');}
    	var handleGraphUndirected = function(event){localStorage.setItem('graphTypeSetting', 'undirected');}
    	var handleGraphDirected = function(event){localStorage.setItem('graphTypeSetting', 'directed');}
    	var handleMergeSum = function(event){localStorage.setItem('mergeTypeSetting', 'sum');}
    	var handleMergeDontMerge = function(event){localStorage.setItem('mergeTypeSetting', 'dont merge');}

    	var createTables = function(event){
       		$.ajax({
    			url: 'data-controller.php/settings',
    			method: 'post',
    			data: {
    				header: headerSetting,
    				graphType: graphTypeSetting,
    				mergeType: mergeTypeSetting,
    				edge: edgeData,
    				node: nodeData
    			},
    			success: function(response){
    				alert(response);
    			},
    			error: function(jqXHR, status, error){
    				alert(jqXHR, status, error);
    			}
    		});

    		$("#file-uploads").hide();
    		$("#data_page").show();

    		event.preventDefault();
    		// window.history.pushState("", "Title", "/~touellette/data_tables");
    	};

    	var returnToUploads = function(event){
    		$("#file-uploads").show();
    		$("#data_page").hide();

    		// Help with URL modification: https://stackoverflow.com/questions/38089507/how-to-change-url-after-success-in-ajax-without-page-reload
    		window.history.pushState("", "Title", "/~touellette/csc302_project");
    	};

    	function handleEdgeFileUpload(event){
    		var file = event.target.files[0];
    		var reader = new FileReader();
    		reader.onload = (function(theFile) {
    			return function(e) {
    				edgeData = e.target.result;// This is where the data is actually read
    				localStorage.setItem('edgeData', edgeData);  
    			};
    		})(file);

    		reader.readAsText(file);

    	}

    	function handleNodeFileUpload(event){
    		var file = event.target.files[0];
    		var reader = new FileReader();
    		reader.onload = (function(theFile) {
    			return function(e){
    				nodeData = e.target.result; // This is where the data is actually read
    				localStorage.setItem('nodeData', nodeData);
    			};
    		})(file);

    		reader.readAsText(file);
    	}

    </script>
    
</head>


<div id="file-uploads">
	<form id="edge-file-upload">
		<h1>Edge File (Required)</h1>
		<input type="file" accept=".csv, .tsv" id="upload-edge-file" class="button" name=file" Value="Upload"/><br>
		<output id="output thing"></output>

		<h4>Header? </h4>
		<input type="radio" id="header-yes" class="radio" name="header"> Yes
		<input type="radio" id="header-no" class="radio" name="header"> No <br>
		<div id="source-selection"></div>
		<div id="target-selection"></div>

		<h4>Graph Type: </h4>
		<input type="radio" id="graph-undirected" class="radio" name="graph-type"> Undirected
		<input type="radio" id="graph-directed" class="radio" name="graph-type"> Directed <br>

		<h4>Merge Type: </h4>
		<input type="radio" id="merge-sum" class="radio" name="merge-type"> Sum
		<input type="radio" id="merge-dontmerge" class="radio" name="merge-type"> Don't Merge
	</form>

	<form id="node-file-upload">
		<h1>Node File (Optional)</h1>
		<input type="file" accept=".csv, .tsv" class="button" id="upload-node-file" Value="Upload">
	</form>

	<input type="submit" id="create-tables" value="Create Tables">


</div>

<div id="data_page">
	<!-- Navbar help: https://www.w3schools.com/bootstrap/bootstrap_navbar.asp -->
	<nav class="navbar navbar-inverse">
		<div class="container-fluid">
			<ul class="nav navbar-nav">
				<li id="return-to-uploads"><a href="#">Return to Uploads</a></li>
				<li><a href="#">Save Data (.tsv)</a></li>
				<li><a href="#">Save Data (.csv)</a></li>
			</ul>
		</div>
	</nav>

	<div class="container">
		<div class="col-lg-5">
			<h2>Nodes and Edges Table</h2>
			<input type="submit" id="edges-view" value="Edges View">
			<input type="submit" id="nodes-view" value="Nodes View">
			<div id="jsGrid"></div>
		</div>
		<div class="col-lg-7">
			<h2>Network Statistics Table</h2>
			<div id="jsGrid"></div>
		</div>
	</div>


</div>

<script>
	    var clients = [
	        { "Name": "Otto Clay", "Age": 25, "Country": 1, "Address": "Ap #897-1459 Quam Avenue", "Married": false },
	        { "Name": "Connor Johnston", "Age": 45, "Country": 2, "Address": "Ap #370-4647 Dis Av.", "Married": true },
	        { "Name": "Lacey Hess", "Age": 29, "Country": 3, "Address": "Ap #365-8835 Integer St.", "Married": false },
	        { "Name": "Timothy Henson", "Age": 56, "Country": 1, "Address": "911-5143 Luctus Ave", "Married": true },
	        { "Name": "Ramona Benton", "Age": 32, "Country": 3, "Address": "Ap #614-689 Vehicula Street", "Married": false }
	    ];
	 
	    var countries = [
	        { Name: "", Id: 0 },
	        { Name: "United States", Id: 1 },
	        { Name: "Canada", Id: 2 },
	        { Name: "United Kingdom", Id: 3 }
	    ];
	 
	    $("#jsGrid").jsGrid({
	        width: "100%",
	        height: "400px",
	 
	        inserting: true,
	        editing: true,
	        sorting: true,
	        paging: true,
	 
	        data: clients,
	 
	        fields: [
	            { name: "Name", type: "text", width: 20, validate: "required" },
	            { name: "Age", type: "number", width: 5 },
	            { name: "Address", type: "text", width: 20 },
	            { name: "Country", type: "select", width: 25, items: countries, valueField: "Id", textField: "Name" },
	            { name: "Married", type: "checkbox", width:5, title: "Is Married", sorting: false },
	            { type: "control", width:15 }
	        ]
	    });
	</script>
